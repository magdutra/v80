ÓDISK  °°°±° ; DISK/ASM°°°²° SELECT0	LD	A,D°°°³° 	CP	16H°°°´° 	LD	A,0°°°µ° 	JR	C,SELECT1°°°¶° 	LD	A,20H°°°·° SELECT1	LD	(SELECT2),A°°°¸° 	LD	A,(DRIV)°°°¹° 	AND	0FH°°±°° 	OR	0°°±±° SELECT2	EQU	$-1°°±²° 	OR	0		;set density°°±³° DENSITY	EQU	$-1°°±´° 	LD	(DRIV),A°°±µ° SELECT	IN	A,(0F0H)	;read status°°±¶° 	AND	80H°°±·° 	LD	A,1		;get drive bit°°±¸° DRIV	EQU	$-1°°±¹° 	OUT	(0F4H),A°°²°° 	RET	Z°°²±° 	PUSH	BC°°²²° 	LD	BC,0°°²³° 	CALL	60H°°²´° 	POP	BC°°²µ° 	JR	SELECT°°²¶° SEEK	CALL	SELECT0	;select drive, set den & precomp°°²·° 	CALL	GETTRK	;get track from table°°²¸° 	OUT	(0F1H),A	;give to FDC°°²¹° 	JR	NZ,SEEK1	;continue if not track 0°°³°° 	CALL	RESTORE		;restore to track 0°°³±° 	RET	NZ		;bad, return°°³²° SEEK1	LD	A,D		;get track°°³³° 	OUT	(0F3H),A	;track to seek°°³´° 	LD	A,18H		;seek command°°³µ° 	CALL	MOVE		;move the head°°³¶° 	RET	NZ		;bad seek°°³·° 	IN	A,(0F1H)	;get track°°³¸° PUTTRK	PUSH	HL		;save this°°³¹° 	LD	HL,CTRACK	;current track table°°´°° 	PUSH	AF°°´±° 	LD	A,0		;get binary drive°°´²° DRIVE	EQU	$-1°°´³° 	ADD	A,L		;point to drive°°´´° 	LD	L,A°°´µ° 	POP	AF		;get track back°°´¶° 	LD	(HL),A		;put in table°°´·° 	POP	HL		;restore HL°°´¸° 	LD	A,E		;set sector register°°´¹° 	OUT	(0F2H),A°°µ°° 	XOR	A°°µ±° 	RET		;Z flag set°°µ²° RESTORE	LD	A,8	;restore command°°µ³° 	CALL	MOVE°°µ´° 	RET	NZ°°µµ° 	CPL°°µ¶° 	BIT	2,A°°µ·° 	RET°°µ¸° MOVE	OR	0	;set step speed°°µ¹° SPEED	EQU	$-1°°¶°° 	OUT	(0F0H),A	;issue command to FDC°°¶±° MOVEWT	CALL	SELECT		;keep drive on°°¶²° 	IN	A,(0F0H)	;read status°°¶³° 	BIT	0,A		;still busy?°°¶´° 	JR	NZ,MOVEWT	;wait till done°°¶µ° 	BIT	4,A		;not found?°°¶¶° 	RET			;Z flag set if OK°°¶·° STEPIN	CALL	SELECT°°¶¸° 	LD	A,58H°°¶¹° 	JP	MOVE°°·°° FORMIT	CALL	BUILDTRK°°·±° 	LD	A,(TRACK)°°·²° 	LD	D,A°°·³° 	CALL	SELECT0°°·´° 	IN	A,(0F0H)°°·µ° 	BIT	6,A°°·¶° 	RET	NZ°°··° TRYWRTG	LD	A,10°°·¸° 	LD	(FCOUNT),A°°·¹° TRYGOW	CALL	W0°°¸°° 	AND	0FCH°°¸±° 	RET	Z°°¸²° 	EX	AF,AF'°°¸³° 	LD	A,0°°¸´° FCOUNT	EQU	$-1°°¸µ° 	DEC	A°°¸¶° 	LD	(FCOUNT),A°°¸·° 	JR	NZ,TRYGOW°°¸¸° 	EX	AF,AF'°°¸¹° 	RET°°¹°° DSKSLO	EX	(SP),HL°°¹±° 	EX	(SP),HL°°¹²° 	EX	(SP),HL°°¹³° 	EX	(SP),HL°°¹´° 	EX	(SP),HL°°¹µ° 	EX	(SP),HL°°¹¶° 	RET°°¹·° R1	CALL	SETNMI		;setup return vectors°°¹¸° 	RET	NZ°°¹¹° 	LD	A,80H°±°°° 	OUT	(0F0H),A°±°±° 	CALL	DSKSLO°±°²° 	LD	E,2°±°³° R100	IN	A,(0F0H)°±°´° 	AND	E°±°µ° 	JR	Z,R100°±°¶° 	INI°±°·° 	LD	A,D°±°¸° R101	OUT	(0F4H),A°±°¹° 	INI°±±°° 	JR	NZ,R101°±±±° 	JR	$°±±²° W1	CALL	SETNMI°±±³° 	RET	NZ°±±´° 	LD	A,0°±±µ° TYPE	EQU	$-1°±±¶° W000	OUT	(0F0H),A°±±·° 	CALL	DSKSLO°±±¸° 	LD	E,2°±±¹° WR100	IN	A,(0F0H)°±²°° 	AND	E°±²±° 	JR	Z,WR100°±²²° 	OUTI°±²³° 	LD	B,60H°±²´° 	DJNZ	$°±²µ° 	LD	A,D°±²¶° WR101	OUT	(0F4H),A°±²·° 	OUTI°±²¸° 	JR	WR101°±²¹° ORDNEW	PUSH	BC°±³°° 	PUSH	DE°±³±° 	PUSH	HL°±³²° 	EX	DE,HL°±³³° 	LD	B,3°±³´° 	DEC	C°±³µ° 	LD	A,(DENSITY)°±³¶° 	OR	A°±³·° 	JR	Z,ORDNEW1°±³¸° 	LD	B,4°±³¹° ORDNEW1	PUSH	BC°±´°° 	LD	A,(HL)°±´±° 	PUSH	HL°±´²° 	INC	HL°±´³° ORDNEW2	LD	E,(HL)°±´´° 	LD	(HL),A°±´µ° 	LD	A,E°±´¶° 	INC	HL°±´·° 	DEC	C°±´¸° 	JR	NZ,ORDNEW2°±´¹° 	POP	HL°±µ°° 	LD	(HL),A°±µ±° 	POP	BC°±µ²° 	DJNZ	ORDNEW1°±µ³° 	POP	HL°±µ´° 	POP	DE°±µµ° 	POP	BC°±µ¶° 	RET°±µ·° BUILDTRK	LD	A,(DENSITY)°±µ¸° 	LD	HL,ORDER°±µ¹° 	OR	A°±¶°° 	JR	Z,GOTORD°±¶±° 	LD	HL,DORDER°±¶²° 	LD	A,(SIZE)°±¶³° 	CP	'A'°±¶´° 	JR	NZ,GOTORD°±¶µ° 	LD	HL,DORDER2°±¶¶° GOTORD	LD	C,(HL)°±¶·° 	INC	HL°±¶¸° 	LD	E,(HL)°±¶¹° 	INC	HL°±·°° 	LD	D,(HL)°±·±° 	INC	HL°±·²° 	CALL	ORDNEW°±·³° 	PUSH	DE°±·´° 	LD	DE,BUFFER°±·µ° 	EX	DE,HL°±·¶° 	CALL	MOVEIN°±··° 	LD	(DESVE),DE°±·¸° SECLP	CALL	MOVEIN°±·¹° 	CALL	MOVEIN°±¸°° 	LD	(HL),0FEH°±¸±° 	INC	HL°±¸²° 	LD	A,(TRACK)°±¸³° 	LD	(HL),A°±¸´° 	INC	HL°±¸µ° 	LD	(HL),0°±¸¶° 	INC	HL°±¸·° 	EX	(SP),HL°±¸¸° 	LD	A,(HL)°±¸¹° 	INC	HL°±¹°° 	EX	(SP),HL°±¹±° 	LD	(HL),A°±¹²° 	INC	HL°±¹³° 	LD	(HL),1°±¹´° 	INC	HL°±¹µ° 	LD	(HL),0F7H°±¹¶° 	INC	HL°±¹·° 	CALL	MOVEIN°±¹¸° 	CALL	MOVEIN°±¹¹° 	CALL	MOVEIN°²°°° 	LD	(HL),0F8H°²°±° 	INC	HL°²°²° 	CALL	FILLDATA°²°³° 	LD	(HL),0F7H°²°´° 	INC	HL°²°µ° 	CALL	MOVEIN°²°¶° 	LD	DE,0°²°·° DESVE	EQU	$-2°²°¸° 	DEC	C°²°¹° 	JR	NZ,SECLP°²±°° 	INC	SP°²±±° 	INC	SP°²±²° 	DEC	DE°²±³° 	LD	A,(DE)°²±´° 	JP	FILL°²±µ° ORDER	DB	10°²±¶° 	DW	ORDERS°²±·° 	DB	1FH,0FFH°²±¸° 	DB	3,0°²±¹° 	DB	3,0°²²°° 	DB	0BH,0FFH°²²±° 	DB	3,0°²²²° 	DB	3,0°²²³° 	DB	0BH,0FFH°²²´° DORDER	DB	18°²²µ° 	DW	ORDERD°²²¶° 	DB	3EH,4EH°²²·° 	DB	0CH,0°²²¸° 	DB	3,0F5H°²²¹° 	DB	16H,4EH°²³°° 	DB	0CH,0°²³±° 	DB	3,0F5H°²³²° 	DB	16H,4EH°²³³° DORDER2	DB	18°²³´° 	DW	ORDERD2°²³µ° 	DB	3EH,4EH°²³¶° 	DB	0CH,0°²³·° 	DB	3,0F5H°²³¸° 	DB	16H,4EH°²³¹° 	DB	0CH,0°²´°° 	DB	3,0F5H°²´±° 	DB	16H,4EH°²´²° ORDERS	DB	0,5,1,6,2,7,3,8,4,9°²´³° ORDERD	DB	1,4,7,0AH,0DH,10H,2,5,8,0BH°²´´° 	DB	0EH,11H,3,6,9,0CH,0FH,12H°²´µ° ORDERD2	DB	0,6,12,1,7,13,2,8,14°²´¶° 	DB	3,9,15,4,10,16,5,11,17°²´·° MOVEIN	LD	A,(DE)°²´¸° 	INC	DE°²´¹° 	LD	B,A°²µ°° 	LD	A,(DE)°²µ±° 	INC	DE°²µ²° FILL	LD	(HL),A°²µ³° 	INC	HL°²µ´° 	DJNZ	FILL°²µµ° 	RET°²µ¶° READ	LD	A,10°²µ·° 	LD	(RCOUNT),A°²µ¸° READGO	PUSH	BC°²µ¹° 	CALL	R1°²¶°° 	POP	HL°²¶±° 	AND	9CH°²¶²° 	RET	Z°²¶³° 	EX	AF,AF'°²¶´° 	LD	B,H°²¶µ° 	LD	C,L°²¶¶° 	LD	A,0°²¶·° RCOUNT	EQU	$-1°²¶¸° 	DEC	A°²¶¹° 	LD	(RCOUNT),A°²·°° 	JR	NZ,READGO°²·±° 	EX	AF,AF'°²·²° 	RET°²·³° WRITE	LD	A,10°²·´° 	LD	(WRCOUNT),A°²·µ° WRGO	PUSH	BC°²·¶° 	CALL	W1°²··° 	POP	HL°²·¸° 	AND	0FCH°²·¹° 	RET	Z°²¸°° 	EX	AF,AF'°²¸±° 	LD	B,H°²¸²° 	LD	C,L°²¸³° 	LD	A,0°²¸´° WRCOUNT	EQU	$-1°²¸µ° 	DEC	A°²¸¶° 	LD	(WRCOUNT),A°²¸·° 	JR	NZ,WRGO°²¸¸° 	EX	AF,AF'°²¸¹° 	RET°²¹°° W0	CALL	SETNMI2°²¹±° 	RET	NZ°²¹²° 	LD	E,2°²¹³° 	LD	B,3°²¹´° 	LD	A,0F0H°²¹µ° 	LD	HL,BUFFER°²¹¶° 	OUT	(0F0H),A°²¹·° 	CALL	DSKSLO°²¹¸° WW101	LD	A,D°²¹¹° 	OUT	(0F4H),A°³°°° 	IN	A,(0F0H)°³°±° 	AND	B°³°²° 	JP	PO,WW101°³°³° 	OUTI°³°´° WW102	LD	A,D°³°µ° 	OUT	(0F4H),A°³°¶° 	IN	A,(0F0H)°³°·° 	AND	E°³°¸° 	JR	Z,WW102°³°¹° 	OUTI°³±°° 	LD	A,D°³±±° WW103	OUT	(0F4H),A°³±²° 	OUTI°³±³° 	JP	WW103°³±´° NMIRET	RETN°³±µ° GETTRK	PUSH	HL°³±¶° 	LD	HL,CTRACK°³±·° 	LD	A,(DRIVE)°³±¸° 	ADD	A,L°³±¹° 	LD	L,A°³²°° 	LD	A,(HL)°³²±° 	POP	HL°³²²° 	OR	A°³²³° 	RET°³²´° SETNMI	LD	(BUFFSAVE),BC	;save buffer°³²µ° 	LD	(SECSAVE),DE	;save track/sector°³²¶° 	LD	H,B		;pass buffer to HL°³²·° 	LD	L,C°³²¸° 	CALL	SEEK		;seek the track°³²¹° 	RET	NZ		;not found°³³°° SETNMI2	LD	A,(DRIV)	;get drive bit°³³±° 	OR	40H		;set wait state°³³²° 	LD	D,A		;save here°³³³° 	PUSH	HL°³³´° 	LD	HL,RETNMI°³³µ° 	LD	(404AH),HL°³³¶° 	POP	HL°³³·° 	IN	A,(0F0H)	;clear FDC latch°³³¸° 	LD	BC,0F3H		;set C = data register°³³¹° 	DI°³´°° 	LD	A,0C0H°³´±° 	OUT	(0E4H),A°³´²° 	XOR	A		;set OK°³´³° 	RET°³´´° RETNMI	POP	HL		;fix the stack°³´µ° 	XOR	A		;reset NMI°³´¶° 	OUT	(0E4H),A	;turn it off°³´·° 	LD	DE,0		;restore track/sector°³´¸° SECSAVE	EQU	$-2°³´¹° 	LD	BC,0		;restore buffer°³µ°° BUFFSAVE	EQU	$-2°³µ±° 	INC	B		;bump page pointer°³µ²° 	LD	HL,NMIRET	;return vector now°³µ³° 	LD	(404AH),HL°³µ´° 	IN	A,(0F0H)	;read status°³µµ° 	LD	(RESULT),A	;save answer°³µ¶° 	PUSH	AF°³µ·° 	LD	A,0D0H°³µ¸° 	OUT	(0F0H),A°³µ¹° 	POP	AF°³¶°° 	EI°³¶±° 	RET°³¶²° FILLDATA	PUSH	DE°³¶³° 	LD	DE,0E5E5H°³¶´° 	LD	A,(DENSITY)°³¶µ° 	OR	A°³¶¶° 	JR	Z,FILLGO°³¶·° 	LD	DE,6DB6H°³¶¸° FILLGO	LD	B,128°³¶¹° 	LD	(HL),D°³·°° 	INC	HL°³·±° 	LD	(HL),E°³·²° 	INC	HL°³·³° 	DJNZ	FILLGO+2°³·´° 	POP	DE°³·µ° 	RET°³·¶° STATCK	CALL	SELECT°³··° 	LD	BC,200H°³·¸° STAT1	DEC	BC°³·¹° 	LD	A,B°³¸°° 	OR	C°³¸±° 	JR	Z,STATBAD°³¸²° 	IN	A,(0F0H)°³¸³° 	AND	2°³¸´° 	JR	NZ,STAT1°³¸µ° 	LD	BC,4000H°³¸¶° STAT2	DEC	BC°³¸·° 	LD	A,B°³¸¸° 	OR	C°³¸¹° 	JR	Z,STATBAD°³¹°° 	IN	A,(0F0H)°³¹±° 	AND	2°³¹²° 	JR	Z,STAT2°³¹³° 	LD	BC,200H°³¹´° STAT3	DEC	BC°³¹µ° 	LD	A,B°³¹¶° 	OR	C°³¹·° 	JR	Z,STATBAD°³¹¸° 	IN	A,(0F0H)°³¹¹° 	AND	2°´°°° 	JR	NZ,STAT3°´°±° 	XOR	A°´°²° 	RET°´°³° STATBAD	OR	1°´°´° 	RET