ÓDISK2 °°°±° ; DISK2/ASM°°°²° SELECT0	LD	A,D°°°³° 	CP	16H°°°´° 	LD	A,0°°°µ° 	JR	C,SELECT1°°°¶° 	LD	A,20H°°°·° SELECT1	LD	(SELECT2),A°°°¸° 	LD	A,(DRIV)°°°¹° 	AND	0FH°°±°° 	OR	0°°±±° SELECT2	EQU	$-1°°±²° 	OR	0		;set density°°±³° DENSITY	EQU	$-1°°±´° 	LD	(DRIV),A°°±µ° SELECT	IN	A,(0F0H)	;read status°°±¶° 	AND	80H°°±·° 	LD	A,1		;get drive bit°°±¸° DRIV	EQU	$-1°°±¹° 	OUT	(0F4H),A°°²°° 	RET	Z°°²±° 	PUSH	BC°°²²° 	LD	BC,0°°²³° 	CALL	60H°°²´° 	POP	BC°°²µ° 	JR	SELECT°°²¶° SEEK	CALL	SELECT0	;select drive, set den & precomp°°²·° 	CALL	GETTRK	;get track from table°°²¸° 	OUT	(0F1H),A	;give to FDC°°²¹° 	JR	NZ,SEEK1	;continue if not track 0°°³°° 	CALL	RESTORE		;restore to track 0°°³±° 	RET	NZ		;bad, return°°³²° SEEK1	LD	A,D		;get track°°³³° 	OUT	(0F3H),A	;track to seek°°³´° 	LD	A,18H		;seek command°°³µ° 	CALL	MOVE		;move the head°°³¶° 	RET	NZ		;bad seek°°³·° 	IN	A,(0F1H)	;get track°°³¸° PUTTRK	PUSH	HL		;save this°°³¹° 	LD	HL,CTRACK	;current track table°°´°° 	PUSH	AF°°´±° 	LD	A,0		;get binary drive°°´²° DRIVE	EQU	$-1°°´³° 	ADD	A,L		;point to drive°°´´° 	LD	L,A°°´µ° 	POP	AF		;get track back°°´¶° 	LD	(HL),A		;put in table°°´·° 	POP	HL		;restore HL°°´¸° 	LD	A,E		;set sector register°°´¹° 	OUT	(0F2H),A°°µ°° 	XOR	A°°µ±° 	RET		;Z flag set°°µ²° RESTORE	LD	A,8	;restore command°°µ³° 	CALL	MOVE°°µ´° 	RET	NZ°°µµ° 	CPL°°µ¶° 	BIT	2,A°°µ·° 	RET°°µ¸° MOVE	OR	0	;set step speed°°µ¹° SPEED	EQU	$-1°°¶°° 	OUT	(0F0H),A	;issue command to FDC°°¶±° MOVEWT	CALL	SELECT		;keep drive on°°¶²° 	IN	A,(0F0H)	;read status°°¶³° 	BIT	0,A		;still busy?°°¶´° 	JR	NZ,MOVEWT	;wait till done°°¶µ° 	BIT	4,A		;not found?°°¶¶° 	RET			;Z flag set if OK°°¶·° STEPIN	CALL	SELECT°°¶¸° 	LD	A,58H°°¶¹° 	JP	MOVE°°·°° FORMIT	CALL	BUILDTRK°°·±° 	LD	A,(TRACK)°°·²° 	LD	D,A°°·³° 	CALL	SELECT0°°·´° 	IN	A,(0F0H)°°·µ° 	BIT	6,A°°·¶° 	RET	NZ°°··° TRYWRTG	CALL	W0°°·¸° 	RET	Z°°·¹° 	CALL	BAIL°°¸°° 	JR	TRYWRTG°°¸±° DSKSLO	PUSH	AF°°¸²° 	POP	AF°°¸³° 	PUSH	AF°°¸´° 	POP	AF°°¸µ° DSKSLO2	PUSH	AF°°¸¶° 	POP	AF°°¸·° 	PUSH	AF°°¸¸° 	POP	AF°°¸¹° 	NOP°°¹°° 	RET°°¹±° R1	CALL	SETNMI		;setup return vectors°°¹²° ;	RET	NZ		;bad already°°¹³° ;	JP	NZ,TERR1°°¹´° 	LD	A,80H°°¹µ° 	OUT	(0F0H),A°°¹¶° 	CALL	DSKSLO2°°¹·° 	LD	E,2°°¹¸° R100	IN	A,(0F0H)°°¹¹° 	AND	E°±°°° 	JR	Z,R100°±°±° 	INI°±°²° 	DI°±°³° 	LD	A,0C0H°±°´° 	OUT	(0E4H),A°±°µ° 	LD	A,D°±°¶° R101	OUT	(0F4H),A°±°·° 	INI°±°¸° 	JR	NZ,R101°±°¹° 	LD	HL,0°±±°° 	JR	R101°±±±° W1	CALL	SETNMI°±±²° 	LD	A,0°±±³° TYPE	EQU	$-1°±±´° 	OUT	(0F0H),A°±±µ° 	CALL	DSKSLO2°±±¶° 	LD	E,2°±±·° WR100	IN	A,(0F0H)°±±¸° 	AND	E°±±¹° 	JR	Z,WR100°±²°° 	OUTI°±²±° 	DI°±²²° 	LD	A,0C0H°±²³° 	OUT	(0E4H),A°±²´° 	LD	B,50H°±²µ° 	DJNZ	$°±²¶° 	LD	A,D°±²·° WR101	OUT	(0F4H),A°±²¸° 	OUTI°±²¹° 	JR	WR101°±³°° ORDNEW	PUSH	BC°±³±° 	PUSH	DE°±³²° 	PUSH	HL°±³³° 	EX	DE,HL°±³´° 	LD	B,3°±³µ° 	DEC	C°±³¶° 	LD	A,(DENSITY)°±³·° 	OR	A°±³¸° 	JR	Z,ORDNEW1°±³¹° 	LD	B,4°±´°° ORDNEW1	PUSH	BC°±´±° 	LD	A,(HL)°±´²° 	PUSH	HL°±´³° 	INC	HL°±´´° ORDNEW2	LD	E,(HL)°±´µ° 	LD	(HL),A°±´¶° 	LD	A,E°±´·° 	INC	HL°±´¸° 	DEC	C°±´¹° 	JR	NZ,ORDNEW2°±µ°° 	POP	HL°±µ±° 	LD	(HL),A°±µ²° 	POP	BC°±µ³° 	DJNZ	ORDNEW1°±µ´° 	POP	HL°±µµ° 	POP	DE°±µ¶° 	POP	BC°±µ·° 	RET°±µ¸° BUILDTRK	LD	A,(DENSITY)°±µ¹° 	LD	HL,ORDER°±¶°° 	OR	A°±¶±° 	JR	Z,GOTORD°±¶²° 	LD	HL,DORDER°±¶³° 	LD	A,(SIZE)°±¶´° 	CP	'A'°±¶µ° 	JR	NZ,GOTORD°±¶¶° 	LD	HL,DORDER2°±¶·° GOTORD	LD	C,(HL)°±¶¸° 	INC	HL°±¶¹° 	LD	E,(HL)°±·°° 	INC	HL°±·±° 	LD	D,(HL)°±·²° 	INC	HL°±·³° 	CALL	ORDNEW°±·´° 	PUSH	DE°±·µ° 	LD	DE,BUFFER°±·¶° 	EX	DE,HL°±··° 	CALL	MOVEIN°±·¸° 	LD	(DESVE),DE°±·¹° SECLP	CALL	MOVEIN°±¸°° 	CALL	MOVEIN°±¸±° 	LD	(HL),0FEH°±¸²° 	INC	HL°±¸³° 	LD	A,(TRACK)°±¸´° 	LD	(HL),A°±¸µ° 	INC	HL°±¸¶° 	LD	(HL),0°±¸·° 	INC	HL°±¸¸° 	EX	(SP),HL°±¸¹° 	LD	A,(HL)°±¹°° 	INC	HL°±¹±° 	EX	(SP),HL°±¹²° 	LD	(HL),A°±¹³° 	INC	HL°±¹´° 	LD	(HL),1°±¹µ° 	INC	HL°±¹¶° 	LD	(HL),0F7H°±¹·° 	INC	HL°±¹¸° 	CALL	MOVEIN°±¹¹° 	CALL	MOVEIN°²°°° 	CALL	MOVEIN°²°±° 	LD	(HL),0FBH°²°²° 	INC	HL°²°³° 	LD	A,0°²°´° 	CALL	FILL°²°µ° 	LD	(HL),0F7H°²°¶° 	INC	HL°²°·° 	CALL	MOVEIN°²°¸° 	LD	DE,0°²°¹° DESVE	EQU	$-2°²±°° 	DEC	C°²±±° 	JR	NZ,SECLP°²±²° 	INC	SP°²±³° 	INC	SP°²±´° 	DEC	DE°²±µ° 	LD	A,(DE)°²±¶° 	JP	FILL°²±·° ORDER	DB	10°²±¸° 	DW	ORDERS°²±¹° 	DB	1FH,0FFH°²²°° 	DB	3,0°²²±° 	DB	3,0°²²²° 	DB	0BH,0FFH°²²³° 	DB	3,0°²²´° 	DB	3,0°²²µ° 	DB	0BH,0FFH°²²¶° DORDER	DB	18°²²·° 	DW	ORDERD°²²¸° 	DB	3EH,4EH°²²¹° 	DB	0CH,0°²³°° 	DB	3,0F5H°²³±° 	DB	16H,4EH°²³²° 	DB	0CH,0°²³³° 	DB	3,0F5H°²³´° 	DB	16H,4EH°²³µ° DORDER2	DB	18°²³¶° 	DW	ORDERD2°²³·° 	DB	3EH,4EH°²³¸° 	DB	0CH,0°²³¹° 	DB	3,0F5H°²´°° 	DB	16H,4EH°²´±° 	DB	0CH,0°²´²° 	DB	3,0F5H°²´³° 	DB	16H,4EH°²´´° ORDERS	DB	0,5,1,6,2,7,3,8,4,9°²´µ° ORDERD	DB	1,7,13,2,8,14,3,9,15°²´¶° 	DB	4,10,16,5,11,17,6,12,18°²´·° ORDERD2	DB	0,6,12,1,7,13,2,8,14°²´¸° 	DB	3,9,15,4,10,16,5,11,17°²´¹° MOVEIN	LD	A,(DE)°²µ°° 	INC	DE°²µ±° 	LD	B,A°²µ²° 	LD	A,(DE)°²µ³° 	INC	DE°²µ´° FILL	LD	(HL),A°²µµ° 	INC	HL°²µ¶° 	DJNZ	FILL°²µ·° 	RET°²µ¸° READ	CALL	R1°²µ¹° 	RET	Z°²¶°° 	EX	AF,AF'		;save error code°²¶±° 	LD	A,(3840H)°²¶²° 	AND	2°²¶³° 	JP	NZ,STOP°²¶´° 	CALL	BAIL°²¶µ° 	JR	READ°²¶¶° WRITE	CALL	W1°²¶·° 	RET	Z°²¶¸° 	CALL	BAIL°²¶¹° 	JR	WRITE°²·°° W0	CALL	SETNMI2°²·±° 	LD	E,2°²·²° 	LD	A,0C0H°²·³° 	OUT	(0E4H),A°²·´° 	LD	A,0F0H°²·µ° 	LD	HL,BUFFER°²·¶° 	OUT	(0F0H),A°²··° 	CALL	DSKSLO°²·¸° 	DI°²·¹° WW101	IN	A,(0F0H)°²¸°° 	AND	E°²¸±° 	JP	Z,WW101°²¸²° 	OUTI°²¸³° WW102	IN	A,(0F0H)°²¸´° 	AND	E°²¸µ° 	JP	Z,WW102°²¸¶° 	OUTI°²¸·° 	LD	A,D°²¸¸° WW103	OUT	(0F4H),A°²¸¹° 	OUTI°²¹°° 	JP	WW103°²¹±° NMIRET	RETN°²¹²° GETTRK	PUSH	HL°²¹³° 	LD	HL,CTRACK°²¹´° 	LD	A,(DRIVE)°²¹µ° 	ADD	A,L°²¹¶° 	LD	L,A°²¹·° 	LD	A,(HL)°²¹¸° 	POP	HL°²¹¹° 	OR	A°³°°° 	RET°³°±° SETNMI	LD	(BUFFSAVE),BC	;save buffer°³°²° 	LD	(SECSAVE),DE	;save track/sector°³°³° 	LD	H,B		;pass buffer to HL°³°´° 	LD	L,C°³°µ° 	CALL	SEEK		;seek the track°³°¶° 	RET	NZ		;not found°³°·° SETNMI2	LD	A,(DRIV)	;get drive bit°³°¸° 	OR	40H		;set wait state°³°¹° 	LD	D,A		;save here°³±°° 	PUSH	HL°³±±° 	LD	HL,RETNMI°³±²° 	LD	(404AH),HL°³±³° 	POP	HL°³±´° ;	IN	A,(0F0H)	;clear FDC latch°³±µ° 	LD	BC,0F3H		;set C = data register°³±¶° 	XOR	A		;set OK°³±·° 	RET°³±¸° RETNMI	POP	HL		;fix the stack°³±¹° 	XOR	A		;reset NMI°³²°° 	OUT	(0E4H),A	;turn it off°³²±° 	LD	DE,0		;restore track/sector°³²²° SECSAVE	EQU	$-2°³²³° 	LD	BC,0		;restore buffer°³²´° BUFFSAVE	EQU	$-2°³²µ° 	INC	B		;bump page pointer°³²¶° 	LD	HL,NMIRET	;return vector now°³²·° 	LD	(404AH),HL°³²¸° 	IN	A,(0F0H)	;read status°³²¹° 	LD	(RESULT),A	;save answer°³³°° 	AND	1CH°³³±° 	RET	Z°³³²° 	LD	A,0D0H°³³³° 	OUT	(0F0H),A°³³´° 	DEC	B°³³µ° 	OR	1°³³¶° 	RET